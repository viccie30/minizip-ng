#!/usr/bin/make -f
# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
#export DH_VERBOSE = 1


include /usr/share/dpkg/default.mk
export DPKG_EXPORT_BUILDTOOLS := 1
include /usr/share/dpkg/buildtools.mk

export DEB_BUILD_MAINT_OPTIONS := hardening=+all qa=+bug reproducible=+all
export DEB_CFLAGS_MAINT_APPEND := $(if $(filter noopt,$(DEB_BUILD_OPTIONS)),,-O3)
export DEB_CFLAGS_MAINT_STRIP := -O2

export DPKG_GENSYMBOLS_CHECK_LEVEL := 4


%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure --builddir=build-shared -- \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_INTERPROCEDURAL_OPTIMIZATION=$(if $(filter noopt,$(DEB_BUILD_OPTIONS)),OFF,ON) \
		-DMZ_BUILD_TESTS=ON \
		-DMZ_BUILD_UNIT_TESTS=ON \
		-DCMAKE_INSTALL_INCLUDEDIR=include/minizip-ng
	dh_auto_configure --builddir=build-static -- \
		-DBUILD_SHARED_LIBS=OFF \
		-DMZ_BUILD_TESTS=ON \
		-DMZ_BUILD_UNIT_TESTS=ON \
		-DCMAKE_INSTALL_INCLUDEDIR=include/minizip-ng

override_dh_auto_build:
	dh_auto_build --builddir=build-shared
	dh_auto_build --builddir=build-static

override_dh_auto_test:
	ln -s test.pem test/cacert.pem
	dh_auto_test --builddir=build-shared --no-parallel
	dh_auto_test --builddir=build-static --no-parallel

override_dh_auto_install:
	# Let shared programs and cmake files overwrite static ones
	dh_auto_install --builddir=build-static
	rm -f debian/tmp/usr/bin/*
	dh_auto_install --builddir=build-shared

override_dh_installdocs:
	dh_installdocs -plibminizip-ng-dev --link-doc=libminizip-ng3.0
	dh_installdocs --remaining-packages
